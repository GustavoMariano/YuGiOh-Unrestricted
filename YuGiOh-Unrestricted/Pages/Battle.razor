@page "/battle/{Code?}"
@page "/battle"
@using System
@using System.Collections.Generic
@using System.Linq
@using Microsoft.AspNetCore.SignalR.Client
@using YuGiOh_Unrestricted.Core.Models
@inject NavigationManager Nav
@inject AppState App
@inject IDeckService DecksSvc

<h3>Battle: @Code</h3>

<iframe name="silent" style="display:none;"></iframe>

@if (match is null)
{
    <div class="join-container">
        <p>Waiting for server...</p>
    </div>
}

@if (match is not null && !match.Started)
{
    var self = match.GetByConn(connectionId ?? "");

    <hr />
    <h4>Select your deck</h4>

    @if (deckOptions is null)
    {
        <p>Loading decks...</p>
    }
    else if (deckOptions.Count == 0)
    {
        <p>No decks found. <a href="/decks">Go to Decks</a></p>
    }
    else
    {
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
            @foreach (var d in deckOptions)
            {
                <form method="post" target="silent" action="@($"/battle/{Code}/select-deck")">
                    <input type="hidden" name="deckId" value="@d.Id" />
                    <input type="hidden" name="userId" value="@App.UserId" />
                    <button type="submit" disabled="@(d.Total < 1 || (self?.IsReady ?? false))">@d.Name (@d.Total)</button>
                </form>
            }
        </div>
        <div style="margin-top:8px;">
            <form method="post" target="silent" action="@($"/battle/{Code}/ready")">
                <input type="hidden" name="userId" value="@App.UserId" />
                <button type="submit" disabled="@(self == null || ((self?.Deck.Count ?? 0) < 1) || self.IsReady)">@((self?.IsReady ?? false) ? "Waiting..." : "Ready")</button>
            </form>
        </div>
        <div style="margin-top:8px; font-size:12px; opacity:.75;">
            <span>You: @(((self?.IsReady ?? false) ? "Ready" : "Not ready"))</span>
            @if (match.Players.Count == 2)
            {
                var oppReady = match.GetOpponent(connectionId ?? "")?.IsReady ?? false;
                <span> • Opponent: @(oppReady ? "Ready" : "Not ready")</span>
            }
        </div>
    }
}

@if (match is not null && match.Started)
{
    var self = match.GetByConn(connectionId ?? "");
    var opp = match.GetOpponent(connectionId ?? "");

    <div class="board">
        @if (opp is not null)
        {
            <div class="player player-top">
                <div class="hand">
                    <h5>Opponent Hand</h5>
                    <div class="hand-cards cards-row">
                        @foreach (var hc in opp.Hand)
                        {
                            var showFront = hc.IsRevealed && !string.IsNullOrWhiteSpace(hc.ImageUrl);
                            <img class="card-img" src="@(showFront? hc.ImageUrl: cardBack)" alt="@(showFront? hc.Name: "Card back")" />
                        }
                    </div>
                </div>

                <div class="row">
                    <div class="deck">Deck (@opp.Deck.Count)</div>
                    @for (int i = 0; i < 5; i++)
                    {
                        var c = opp.FieldSpellTraps.ElementAtOrDefault(i);
                        <div class="slot spelltrap">@((c == null) ? "(empty)" : (c.IsFaceDown ? "(face down)" : c.Name))</div>
                    }
                </div>
                <div class="row">
                    <div class="graveyard">GY (@opp.Graveyard.Count)</div>
                    @for (int i = 0; i < 5; i++)
                    {
                        var c = opp.FieldMonsters.ElementAtOrDefault(i);
                        <div class="slot monster">@((c == null) ? "(empty)" : (c.IsFaceDown ? "(face down)" : c.Name))</div>
                    }
                    <div class="field-magic">@((opp.FieldMagic == null) ? "(empty)" : (opp.FieldMagic.IsFaceDown ? "(face down)" : opp.FieldMagic.Name))</div>
                </div>
                <div class="player-info opp"><strong>@opp.Name</strong> — LP: @opp.LifePoints</div>
            </div>
        }

        @if (self is not null)
        {
            <div class="player player-bottom">
                <div class="player-info me"><strong>@self.Name</strong> — LP: @self.LifePoints</div>

                <div class="row">
                    <div class="field-magic">@((self.FieldMagic == null) ? "(empty)" : self.FieldMagic.Name)</div>
                    @for (int i = 0; i < 5; i++)
                    {
                        var c = self.FieldMonsters.ElementAtOrDefault(i);
                        <div class="slot monster">@((c == null) ? "(empty)" : c.Name)</div>
                    }
                    <div class="graveyard">GY (@self.Graveyard.Count)</div>
                </div>
                <div class="row">
                    @for (int i = 0; i < 5; i++)
                    {
                        var c = self.FieldSpellTraps.ElementAtOrDefault(i);
                        <div class="slot spelltrap">@((c == null) ? "(empty)" : c.Name)</div>
                    }
                    <div class="deck">
                        Deck (@self.Deck.Count)
                        <div class="draw-box">
                            <form method="post" target="silent" action="@($"/battle/{Code}/draw")">
                                <input type="hidden" name="userId" value="@App.UserId" />
                                <button type="submit">Draw 1</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="hand">
                    <h5>Your Hand</h5>
                    <div class="hand-cards cards-row">
                        @foreach (var c in self.Hand)
                        {
                            <form method="get" action="@($"/battle/{Code}")">
                                <input type="hidden" name="details" value="@c.Id" />
                                <button type="submit" class="card-btn">
                                    <img class="card-img" src="@(string.IsNullOrWhiteSpace(c.ImageUrl) ? cardBack : c.ImageUrl)" alt="@c.Name" title="@c.Name" />
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

@if (!string.IsNullOrWhiteSpace(detailsId) && selected is not null)
{
    <dialog open class="modal">
        <div class="modal-header">
            <strong>@selected.Name</strong>
        </div>
        <div class="modal-body">
            <div style="display:flex; gap:16px;">
                <img src="@(string.IsNullOrWhiteSpace(selected.ImageUrl) ? cardBack : selected.ImageUrl)" alt="@selected.Name" style="width:160px; height:auto;" />
                <div style="min-width:240px;">
                    @if (selected.Level.HasValue && selected.Level.Value > 0)
                    {
                        <div>Level: @selected.Level</div>
                    }
                    @if (selected.Attack.HasValue && selected.Attack.Value > 0)
                    {
                        <div>ATK: @selected.Attack</div>
                    }
                    @if (selected.Defense.HasValue && selected.Defense.Value > 0)
                    {
                        <div>DEF: @selected.Defense</div>
                    }
                    <div style="margin-top:8px; white-space:pre-wrap;">@selected.Description</div>
                </div>
            </div>

            <hr />

            <div style="display:grid; grid-template-columns: repeat(2, minmax(240px, 1fr)); gap:12px;">
                <form method="post" target="silent" action="@($"/battle/{Code}/reveal")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="reveal" value="true" />
                    <button type="submit">Reveal to opponent</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/reveal")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="reveal" value="false" />
                    <button type="submit">Hide from opponent</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/facedown")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="faceDown" value="true" />
                    <button type="submit">Set face-down</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/facedown")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="faceDown" value="false" />
                    <button type="submit">Set face-up</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/defense")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="defense" value="true" />
                    <button type="submit">Defense position</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/defense")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="defense" value="false" />
                    <button type="submit">Attack position</button>
                </form>
            </div>

            <h5 style="margin-top:16px;">Move to your zone</h5>
            <div style="display:grid; grid-template-columns: repeat(2, minmax(260px, 1fr)); gap:10px;">
                <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="targetUserId" value="@selfUserId" />
                    <input type="hidden" name="zone" value="FieldMonster" />
                    <label>Index <input type="number" name="index" value="0" min="0" max="4" /></label>
                    <button type="submit">Place as monster</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="targetUserId" value="@selfUserId" />
                    <input type="hidden" name="zone" value="FieldSpellTrap" />
                    <label>Index <input type="number" name="index" value="0" min="0" max="4" /></label>
                    <button type="submit">Place as spell/trap</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="targetUserId" value="@selfUserId" />
                    <input type="hidden" name="zone" value="FieldMagic" />
                    <button type="submit">Place as field spell</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="targetUserId" value="@selfUserId" />
                    <input type="hidden" name="zone" value="Graveyard" />
                    <button type="submit">Send to graveyard</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="targetUserId" value="@selfUserId" />
                    <input type="hidden" name="zone" value="Hand" />
                    <button type="submit">Return to hand</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="targetUserId" value="@selfUserId" />
                    <input type="hidden" name="zone" value="Deck" />
                    <input type="hidden" name="deckPos" value="Top" />
                    <button type="submit">Top of deck</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="targetUserId" value="@selfUserId" />
                    <input type="hidden" name="zone" value="Deck" />
                    <input type="hidden" name="deckPos" value="Middle" />
                    <button type="submit">Middle of deck</button>
                </form>

                <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                    <input type="hidden" name="cardId" value="@selected.Id" />
                    <input type="hidden" name="targetUserId" value="@selfUserId" />
                    <input type="hidden" name="zone" value="Deck" />
                    <input type="hidden" name="deckPos" value="Bottom" />
                    <button type="submit">Bottom of deck</button>
                </form>
            </div>

            @if (opponentUserId != Guid.Empty)
            {
                <h5 style="margin-top:16px;">Move to opponent zone</h5>
                <div style="display:grid; grid-template-columns: repeat(2, minmax(260px, 1fr)); gap:10px;">
                    <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                        <input type="hidden" name="cardId" value="@selected.Id" />
                        <input type="hidden" name="targetUserId" value="@opponentUserId" />
                        <input type="hidden" name="zone" value="FieldMonster" />
                        <label>Index <input type="number" name="index" value="0" min="0" max="4" /></label>
                        <button type="submit">Opponent monster zone</button>
                    </form>

                    <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                        <input type="hidden" name="cardId" value="@selected.Id" />
                        <input type="hidden" name="targetUserId" value="@opponentUserId" />
                        <input type="hidden" name="zone" value="FieldSpellTrap" />
                        <label>Index <input type="number" name="index" value="0" min="0" max="4" /></label>
                        <button type="submit">Opponent spell/trap zone</button>
                    </form>

                    <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                        <input type="hidden" name="cardId" value="@selected.Id" />
                        <input type="hidden" name="targetUserId" value="@opponentUserId" />
                        <input type="hidden" name="zone" value="FieldMagic" />
                        <button type="submit">Opponent field spell</button>
                    </form>

                    <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                        <input type="hidden" name="cardId" value="@selected.Id" />
                        <input type="hidden" name="targetUserId" value="@opponentUserId" />
                        <input type="hidden" name="zone" value="Hand" />
                        <button type="submit">Give to opponent hand</button>
                    </form>

                    <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                        <input type="hidden" name="cardId" value="@selected.Id" />
                        <input type="hidden" name="targetUserId" value="@opponentUserId" />
                        <input type="hidden" name="zone" value="Graveyard" />
                        <button type="submit">Send to opponent GY</button>
                    </form>

                    <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                        <input type="hidden" name="cardId" value="@selected.Id" />
                        <input type="hidden" name="targetUserId" value="@opponentUserId" />
                        <input type="hidden" name="zone" value="Deck" />
                        <input type="hidden" name="deckPos" value="Top" />
                        <button type="submit">Opponent deck top</button>
                    </form>

                    <form method="post" target="silent" action="@($"/battle/{Code}/move")">
                        <input type="hidden" name="cardId" value="@selected.Id" />
                        <input type="hidden" name="targetUserId" value="@opponentUserId" />
                        <input type="hidden" name="zone" value="Deck" />
                        <input type="hidden" name="deckPos" value="Bottom" />
                        <button type="submit">Opponent deck bottom</button>
                    </form>
                </div>
            }

            <div style="margin-top:16px;">
                <form method="get" action="@($"/battle/{Code}")">
                    <button type="submit">Close</button>
                </form>
            </div>
        </div>
    </dialog>
}

@code {
    [Parameter] public string? Code { get; set; }

    private HubConnection? hub;
    private string? connectionId;
    private RuntimeMatch? match;
    private List<DeckOption>? deckOptions;
    private bool joined;
    private string cardBack = "/img/card-back.jpg";

    private string? detailsId;
    private RuntimeCard? selected;
    private Guid selfUserId => match?.GetByConn(connectionId ?? "")?.UserId ?? Guid.Empty;
    private Guid opponentUserId => match?.GetOpponent(connectionId ?? "")?.UserId ?? Guid.Empty;

    private sealed class DeckOption
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public int Total { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        if (string.IsNullOrWhiteSpace(Code))
            Code = query["code"];
        detailsId = query["details"];

        hub = new HubConnectionBuilder()
            .WithUrl(Nav.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect()
            .Build();

        hub.On<string>("SetConnectionId", id => connectionId = id);
        hub.On<RuntimeMatch>("UpdateMatch", async m =>
        {
            match = m;
            TryBindSelected();
            await InvokeAsync(StateHasChanged);
        });

        await hub.StartAsync();

        if (!string.IsNullOrWhiteSpace(Code))
        {
            await hub.InvokeAsync("JoinGroup", Code);
            await hub.InvokeAsync("RequestSync", Code);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!joined && hub != null && !string.IsNullOrWhiteSpace(Code) && App.UserId != Guid.Empty)
        {
            await hub.InvokeAsync("JoinBattle", Code, App.Nickname, App.UserId);
            await hub.InvokeAsync("RequestSync", Code);
            joined = true;

            if (deckOptions == null)
            {
                var decks = await DecksSvc.GetUserDecksAsync(App.UserId);
                deckOptions = decks?
                    .Select(d => new DeckOption
                    {
                        Id = d.Id,
                        Name = d.Name,
                        Total = d.Cards?.Sum(c => c.Count) ?? 0
                    })
                    .ToList() ?? new List<DeckOption>();
                StateHasChanged();
            }
        }
    }

    private void TryBindSelected()
    {
        selected = null;
        if (match == null || string.IsNullOrWhiteSpace(detailsId)) return;

        foreach (var p in match.Players)
        {
            var h = p.Hand.FirstOrDefault(x => x.Id == detailsId);
            if (h != null) { selected = h; return; }

            var d = p.Deck.FirstOrDefault(x => x.Id == detailsId);
            if (d != null) { selected = d; return; }

            var g = p.Graveyard.FirstOrDefault(x => x.Id == detailsId);
            if (g != null) { selected = g; return; }

            for (int i = 0; i < p.FieldMonsters.Count; i++)
                if (p.FieldMonsters[i]?.Id == detailsId) { selected = p.FieldMonsters[i]; return; }

            for (int i = 0; i < p.FieldSpellTraps.Count; i++)
                if (p.FieldSpellTraps[i]?.Id == detailsId) { selected = p.FieldSpellTraps[i]; return; }

            if (p.FieldMagic?.Id == detailsId) { selected = p.FieldMagic; return; }
        }
    }
}
